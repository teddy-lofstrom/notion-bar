<!-- ===== FILE 2: progress-bar.html ===== -->
<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Progress – Bar (Notion)</title>
<style>
  :root{
    --font: -apple-system,BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    --bg:#FFF; --fg:#111; --subtle:#575757; --outline: rgba(0,0,0,.08);
    --bar-bg:#e9e9e9; --bar-fill:#111;
    --r: 16px; --shadow: 0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06);
    /* Tjockare bar */
    --bar-h: clamp(28px,5vw,48px);
  }
  [data-theme="dark"]{ --bg:#191919; --fg:#f2f2f2; --subtle:#c9c9c9; --outline:rgba(255,255,255,.08); --bar-bg:#2a2a2a; --bar-fill:#fff; }
  
  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font-family:var(--font);
    overflow:hidden; /* tar bort scroll-baren */
  }

  .app{ min-height:100dvh; display:grid; align-content:center; padding:min(24px,4vw); }
  .track{ position:relative; margin-inline:auto; width:min(92vw, 980px); }
  /* 15% rundade hörn */
  .bar{ position:relative; height:var(--bar-h); background:var(--bar-bg); border-radius:15%; overflow:hidden; box-shadow: inset 0 0 0 1px var(--outline), var(--shadow); }
  .fill{ position:absolute; inset:0 auto 0 0; width:0%; background:var(--bar-fill); border-radius:inherit; }

  /* Ticks är borttagna, men om något skulle skriva in dem: göm dem. */
  .ticks{ display:none !important; }
</style>
</head>
<body>
  <div class="app">
    <div class="track" id="track">
      <div class="bar"><div class="fill" id="fill"></div></div>
      <!-- <div class="ticks" id="ticks"></div> -->
    </div>
  </div>
<script>
const $ = s => document.querySelector(s);
const fill = $('#fill');
const LAT=59.6099, LON=16.5448;
const HAS_STORAGE=(()=>{try{localStorage.setItem('_x','1');localStorage.removeItem('_x');return true;}catch(e){return false;}})();
const getRaw=k=>HAS_STORAGE?localStorage.getItem(k):null; const setRaw=(k,v)=>{try{if(!HAS_STORAGE)return false;localStorage.setItem(k,v);return true;}catch(e){return false;}};
const THEME_KEY='walltimer.theme.osSync';

function norm(v){ if(v==null) return "00:00"; v=String(v).trim().replace(/[.,;\-\s]+/g,':'); const m=v.match(/^(\d{1,2})(?::?(\d{1,2}))?/); let h=m&&m[1]!=null?parseInt(m[1],10):0; let mi=m&&m[2]!=null?parseInt(m[2],10):0; if(isNaN(h))h=0; if(isNaN(mi))mi=0; h=Math.max(0,Math.min(23,h)); mi=Math.max(0,Math.min(59,mi)); return (h<10?'0':'')+h+':'+(mi<10?'0':'')+mi; }
const t2m=t=>{const [h,m]=norm(t).split(':').map(Number);return (h%24)*60+(m||0);} ;
function sanitizeArray(a){return a.map(p=>({name:String(p.name||'Period'),start:norm(p.start),end:norm(p.end)}));}
function getPeriods(){ const raw=getRaw('walltimer.periods'); if(raw){ try{ const a=JSON.parse(raw); if(Array.isArray(a)&&a.length) return sanitizeArray(a); }catch(e){} } return sanitizeArray([{name:"Morgon",start:"06:30",end:"08:00"},{name:"Förmiddag",start:"08:00",end:"12:00"},{name:"Lunch",start:"12:00",end:"13:00"},{name:"Eftermiddag",start:"13:00",end:"17:00"},{name:"Kväll",start:"17:00",end:"22:15"},{name:"Kvällsrutin",start:"22:15",end:"22:30"},{name:"Natt",start:"22:30",end:"06:30"}]); }
function expand(ps){ const out=[]; for(const p of ps){ const a=t2m(p.start), b=t2m(p.end); if(b>=a) out.push({name:p.name,a,b}); else { out.push({name:p.name,a,b:1440}); out.push({name:p.name,a:0,b}); } } out.sort((x,y)=>x.a-y.a); return out; }
function pick(ps){ const n=new Date(); const now=n.getHours()*60+n.getMinutes()+n.getSeconds()/60; const list=expand(ps); let idx=-1,cur=null; for(let i=0;i<list.length;i++){ const p=list[i]; if(now>=p.a && now<p.b){ idx=i; cur=p; break; } } if(idx===-1){ let nxtIdx=list.findIndex(p=>p.a>now); if(nxtIdx===-1) nxtIdx=0; return { idx:-1, list, cur:{name:'Paus',a:now,b:list[nxtIdx].a}, nxt:list[nxtIdx] }; } return { idx, list, cur:list[idx] };
}
function mergedSpan(list, idx){ const cur=list[idx]; let start=cur.a,end=cur.b; if(cur.b===1440){ const next=list[(idx+1)%list.length]; if(next && next.name===cur.name && next.a===0){ end=1440+next.b; } } if(cur.a===0){ const prev=list[(idx-1+list.length)%list.length]; if(prev && prev.name===cur.name && prev.b===1440){ start=prev.a; end=1440+cur.b; } } return {start,end}; }
function wrapDiff(nowMin,start,end){ let n=nowMin; if(end>1440 && n<start) n+=1440; const total=(end-start)*60*1000; const passed=(n-start)*60*1000; const remain=Math.max(0,total-passed); return {total,passed,remain}; }

function setTheme(mode){ document.documentElement.setAttribute('data-theme', mode==='dark'?'dark':'light'); }
function getOsPref(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'; }
function toRad(d){return d*Math.PI/180;} function toDeg(r){return r*180/Math.PI;} function dayOfYear(d){ const n=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const start=new Date(Date.UTC(d.getFullYear(),0,0)); return Math.floor((n-start)/86400000); }
function solarTimes(date,lat,lon){ const n=dayOfYear(date); const lngHour=lon/15; function calc(isRise){ const t=n+(((isRise?6:18)-lngHour)/24); const M=(0.9856*t)-3.289; let L=M+(1.916*Math.sin(toRad(M)))+(0.020*Math.sin(toRad(2*M)))+282.634; L=(L+360)%360; let RA=toDeg(Math.atan(0.91764*Math.tan(toRad(L)))); RA=(RA+360)%360; const Lq=Math.floor(L/90)*90; const RAq=Math.floor(RA/90)*90; RA=RA+(Lq-RAq); RA/=15; const sinDec=0.39782*Math.sin(toRad(L)); const cosDec=Math.cos(Math.asin(sinDec)); const cosH=(Math.cos(toRad(90.833))-(sinDec*Math.sin(toRad(lat))))/(cosDec*Math.cos(toRad(lat))); if(cosH>1||cosH<-1) return null; const H=isRise? (360-toDeg(Math.acos(cosH))) : toDeg(Math.acos(cosH)); const Hh=H/15; const T=Hh+RA-(0.06571*t)-6.622; let UT=(T-lngHour)%24; if(UT<0) UT+=24; const hours=Math.floor(UT); const mins=Math.round((UT-hours)*60); return new Date(date.getFullYear(), date.getMonth(), date.getDate(), hours, mins, 0); }
  return {sunrise:calc(true), sunset:calc(false)}; }
let themeTimer=null; function scheduleThemeBySun(){ if(themeTimer){clearTimeout(themeTimer);themeTimer=null;} const now=new Date(); const {sunrise,sunset}=solarTimes(now,LAT,LON); let nextSwitch=null, mode='light'; if(sunrise&&sunset){ if(now>=sunset){ mode='dark'; const t=new Date(now); t.setDate(now.getDate()+1); nextSwitch=solarTimes(t,LAT,LON).sunrise; } else if(now<sunrise){ mode='dark'; nextSwitch=sunrise; } else { mode='light'; nextSwitch=sunset; } } else { mode=getOsPref(); nextSwitch=new Date(now.getTime()+3600*1000); } setTheme(mode); const wait=Math.max(1000, nextSwitch-now); themeTimer=setTimeout(scheduleThemeBySun, wait); }
function applyTheme(){ if(getRaw(THEME_KEY)==='1'){ setTheme(getOsPref()); } else { scheduleThemeBySun(); } }
if(window.matchMedia){ const mq=window.matchMedia('(prefers-color-scheme: dark)'); mq.addEventListener?.('change',e=>{ if(getRaw(THEME_KEY)==='1') setTheme(e.matches?'dark':'light'); }); }

/* Ingen tick-ritning längre */
function loop(){
  const ps=getPeriods();
  const pickRes=pick(ps);
  const cur=pickRes.cur;
  const n=new Date();
  const nMin=n.getHours()*60+n.getMinutes()+n.getSeconds()/60;

  let spanStart=cur.a, spanEnd=cur.b;
  if(pickRes.idx!==-1){
    const span=mergedSpan(pickRes.list,pickRes.idx);
    spanStart=span.start; spanEnd=span.end;
  }
  const {total,passed}=wrapDiff(nMin,spanStart,spanEnd);
  const pct = total>0? Math.min(100, Math.max(0, (passed/total)*100)) : 100;
  fill.style.width=pct+'%';

  requestAnimationFrame(loop);
}

(function init(){ applyTheme(); loop(); })();
</script>
</body>
</html>
